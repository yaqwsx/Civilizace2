{% extends "base.html" %}

{% block content %}
<div class="text-center">
    <h1 style="font-size:80px">Odpočet do konce {{generation}}. generace</h1>
    <div id="countdown" style="font-size:300px"></div>
    <div id="pauseMessage" style="font-size:80px" class="hidden">
        Generace jsou pozastaveny.
    </div>

    <div id="statusMessage">
    </div>

    <form method="post" class="hidden">
        {% csrf_token %}
    </form>
</div>

<script>
    document.getElementById("content").classList.remove("container");
    var pauseMessage = document.querySelector('#pauseMessage');
    var timerDiv = document.querySelector('#countdown')

    var running = {{ params.running|yesno:"true,false" }};
    var reload = false;
    var period = {{ params.period }};
    var timer = period;
    var interval;
    interval = setInterval(function () {
        if (reload) {
            reload = false;
            timer = period;
        }

        if (!running) {
            timerDiv.textContent = "";
            pauseMessage.classList.remove("hidden");
            return;
        }

        var minutes = parseInt(timer / 60, 10);
        var seconds = parseInt(timer % 60, 10);

        minutes = minutes < 10 ? "0" + minutes : minutes;
        seconds = seconds < 10 ? "0" + seconds : seconds;

        pauseMessage.classList.add("hidden");
        timerDiv.textContent = minutes + ":" + seconds;

        if (--timer < 0) {
            clearInterval(interval)
            document.getElementsByTagName("FORM")[0].submit();
        }
    }, 1000);

    var statusMessage = document.querySelector('#statusMessage');
    setInterval(function() {
        var request = new XMLHttpRequest();
        request.open('GET', '/generation/params', true);

        request.onload = function() {
            if (request.status >= 200 && request.status < 400) {
                var data = JSON.parse(request.responseText);
                period = data["period"];
                running = data["running"];
                if (data["forceUpdate"]) {
                    reload = true;
                    request.open('POST', '/generation/params', true);
                    request.send();
                }
                statusMessage.textContent = "";
            } else {
                statusMessage.textContent = "Přijata špatná data: " + request.statusText;
            }
        };

        request.onerror = function() {
            statusMessage.textContent = "Spojení ztraceno: " + request.statusText;
        };

        request.send();
    }, 1500);
</script>
{% endblock %}